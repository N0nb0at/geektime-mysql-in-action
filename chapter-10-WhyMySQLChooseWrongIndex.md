---
title: MySQL-10-MySQL为什么有时候会选错索引？
date: 2019/04/17 14:17:02
categories:
  - [MySQL-in-Action]
tags:
  - [geektime]
  - [MySQL]
---

## 优化器的逻辑

优化器选择索引的目的，是找到一个最优的执行方案，并用最小的代价去执行语句。在数据库中，扫描行数是影响执行代价的因素之一。扫描的行数越少，意味着访问磁盘数据的次数越小，消耗的 CPU 资源越少。

扫描行数并不是唯一的判断标准，优化器还会结合是否使用临时表、是否排序等因素进行综合判断。

### 扫描行数是怎么判断的？

MySQL 在真正开始执行语句之前，并不能精确地知道满足这个条件的记录有多少条，而只能根据统计信息来估算记录数。

这个统计信息就是索引的『区分度』。显然，一个索引上不同的值越多，这个索引的区分度就越好。一个索引上不同值的个数，称为『基数（cardinality）』。这个基数越大，索引的区分度越好。

MySQL 使用采样统计的方法来获得索引的基数。采样统计的时候，InnoDB 默认会选择 N 个数据页，统计这些页面上的不同值，得到一个平均值，然后乘以这个索引的页面数，就得到了这个索引的基数。当表持续更新的行数超过 1/M 的时候，会触发重新做一次索引统计。

在 MySQL 中，有两种存储索引统计的方式，可以通过设置参数 innodb_stats_persistent 的值来选择：

- 设置为 on 的时候，表示统计信息会持久化存储。这时，默认的 N 是 20，M 是 10。
- 设置为 off 的时候，表示统计信息只会存储在内存中。这时，默认的 N 是 8，M 是 16。

由于是采样统计，所以不管 N 是 20 还是 8，这个基数都不是十分准确的。其实索引统计只是一个输入，对于一个具体的语句来说，优化器还要判断，执行这个语句本身要扫描多少行。

如果使用索引 a，每次从索引 a 上拿到一个值，都要回到主键索引上查出整行数据，这个代价优化器也要算进去。而如果直接在主键索引上扫描，没有额外的代价。优化器会估算这两个选择的代价。

# 索引选择异常和处理

大多数情况下，优化器都能找到正确的索引，但偶尔还是会碰到特殊情况，原本可以执行得很快的 SQL，执行速度会比预期慢。

常用的解决方法：

- 采用 `force index` 强行选择一个索引
- 考虑修改语句，引导 MySQL 使用期望的索引
- 在有些场景下，可以新建一个更合适的索引，来提供给优化器做选择，或者删除误用的索引
