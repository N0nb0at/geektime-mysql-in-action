---
title: 基础架构：一条SQL查询语句是如何执行的？
date: 2019/04/02 07:32:51
categories: 
  - [study]
tags: 
  - [geektime]
  - [MySQL]
---

#  基础架构：一条SQL查询语句是如何执行的？

![MySQL 逻辑架构图](https://raw.githubusercontent.com/N0nb0at/mysql-in-action-geektime/dev/resource/MySQL-architectural-sketch.png)

<!-- more -->

## 连接器

连接器负责根客户端建立连接、获取权限、维持和管理链接：

``` bash
mysql -h$ip -P$port -u$user -p
```

一个用户成功建立连接后，即使用管理员账号对这个用户的权限做了修改，也不会影响已经存在连接的权限。修改完成后，只有再新建立的连接才会使用心得权限设置。

## 查询缓存

MySQL 拿到一个查询请求后，会先到查询缓存查看，之前是否执行过这条语句。之前执行过的语句及其结果可能会以 key-value 对的形式，被直接缓存在内存中。key 是查询的语句，value 是查询的结果。

如果语句不在查询缓存中，就会继续后面的执行阶段。执行完成后，执行结果就会被存入查询缓存中。

大多数情况下不要使用查询缓存，因为查询缓存的失效非常频繁，只要有对一个表的更新，这个表上的所有查询缓存都会被清空。

MySQL 8.0 版本直接将查询缓存的整块功能删掉了。

## 分析器

分析器先回做『词法分析』，识别 SQL 语句中的关键字、表名、列名等内容；然后做『语法分析』，会根据语法规则，判断输入的 SQL 语句是否满足 MySQL 语法。

## 优化器

优化器是在表里面有过个索引的时候，决定使用哪个索引 ；或者在一个语句有过边关联的时候，决定各个表的连接顺序。

## 执行器

MySQL 通过分析器知道了你要做什么，通过优化器知道了该怎么做，于是就进入了执行器阶段，开始执行语句。

开始执行的时候，要先判断一下对将要执行的表是否有查询的权限，在工程实现上，如果命中查询缓存，会在查询缓存返回结果的时候做权限验证，查询也会在优化器之前调用 precheck 验证权限。

## 小结问题

如果表 T 中没有字段 k，而执行了语句 `SELECT * FROM T WHERE k=1;` 肯定会报『不存在这个列』的错误：『Unknown column 'k' in 'where clause'』。你觉得这个错误应该是在哪个阶段报出来的？

> @一步：我认为是优化器的，优化器会进行优化分析，比如用先执行哪个条件，使用哪个索引。如果没有对应的字段就会报错的，我看其他评论说是执行器，原因是这个时候才打开表获取数据，但是表的字段不是数据啊，是事先定义好的，所以可以直接读取的，不需要打开表。

> @圈圈圆圆：《高性能mysql》里提到解析器和预处理器。解析器处理语法和解析查询, 生成一课对应的解析树。预处理器进一步检查解析树的合法。比如: 数据表和数据列是否存在, 别名是否有歧义等。如果通过则生成新的解析树，再提交给优化器。所以我觉得课后习题的错误应该发生在在分析器处理阶段
